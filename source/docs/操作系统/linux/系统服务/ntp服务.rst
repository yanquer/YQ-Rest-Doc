========================
ntp服务
========================

NTP（Network Time Protocol，网络时间协议）是由RFC 1305定义的时间同步协议，用来在分布式时间服务器
和客户端之间进行时间同步。NTP基于UDP报文进行传输，使用的UDP端口号为123。

使用NTP的目的是对网络内所有具有时钟的设备进行时钟同步，使网络内所有设备的时钟保持一致，从而使设备
能够提供基于统一时间的多种应用。

对于运行NTP的本地系统，既可以接收来自其他时钟源的同步，又可以作为时钟源同步其他的时钟，并且可以和

其他设备互相同步。

NTP的报文格式
========================

NTP有两种不同类型的报文，一种是时钟同步报文，另一种是控制报文。控制报文仅用于需要网络管理的场合，它
对于时钟同步功能来说并不是必需的，这里不做介绍。

主要字段的解释如下：

- LI（Leap Indicator）：长度为2比特，值为“11”时表示告警状态，时钟未被同步。为其他值时NTP本身不做处理。
- VN（Version Number）：长度为3比特，表示NTP的版本号，目前的最新版本为3。
- Mode：长度为3比特，表示NTP的工作模式。不同的值所表示的含义分别是：0未定义、1表示主动对等体模式、
  2表示被动对等体模式、3表示客户模式、4表示服务器模式、5表示广播模式或组播模式、6表示此报文为NTP控制
  报文、7预留给内部使用。
- Stratum：系统时钟的层数，取值范围为1～16，它定义了时钟的准确度。层数为1的时钟准确度最高，准确度从
  1到16依次递减，层数为16的时钟处于未同步状态，不能作为参考时钟。
- Poll：轮询时间，即两个连续NTP报文之间的时间间隔。
- Precision：系统时钟的精度。
- Root Delay：本地到主参考时钟源的往返时间。
- Root Dispersion：系统时钟相对于主参考时钟的最大误差。
- Reference Identifier：参考时钟源的标识。
- Reference Timestamp：系统时钟最后一次被设定或更新的时间。
- Originate Timestamp：NTP请求报文离开发送端时发送端的本地时间。
- Receive Timestamp：NTP请求报文到达接收端时接收端的本地时间。
- Transmit Timestamp：应答报文离开应答者时应答者的本地时间。
- Authenticator：验证信息。

NTP的工作模式
========================

设备可以采用多种NTP工作模式进行时间同步：

- 客户端/服务器模式
- 对等体模式
- 广播模式
- 组播模式

用户可以根据需要选择合适的工作模式。在不能确定服务器或对等体IP地址、网络中需要同步的设备很多等情况
下，可以通过广播或组播模式实现时钟同步；客户端/服务器和对等体模式中，设备从指定的服务器或对等体获得

时钟同步，增加了时钟的可靠性。

1. 客户端/服务器模式

在客户端/服务器模式中，客户端向服务器发送时钟同步报文，报文中的Mode字段设置为3（客户模式）。
服务器端收到报文后会自动工作在服务器模式，并发送应答报文，报文中的Mode字段设置为4（服务器模式）。
客户端收到应答报文后，进行时钟过滤和选择，并同步到优选的服务器。
在该模式下，客户端能同步到服务器，而服务器无法同步到客户端。

2. 对等体模式

在对等体模式中，主动对等体和被动对等体之间首先交互Mode字段为3（客户端模式）和4（服务器模式）的NTP报文。
之后，主动对等体向被动对等体发送时钟同步报文，报文中的Mode字段设置为1（主动对等体），
被动对等体收到报文后自动工作在被动对等体模式，并发送应答报文，报文中的Mode字段设置为2（被动对等体）。
经过报文的交互，对等体模式建立起来。主动对等体和被动对等体可以互相同步。如果双方的时钟都已经同步，则以层数小的时钟为准

3. 广播模式

在广播模式中，服务器端周期性地向广播地址255.255.255.255发送时钟同步报文，报文中的Mode字段设置为5（广播模式）。
客户端侦听来自服务器的广播报文。当客户端接收到第一个广播报文后，
客户端与服务器交互Mode字段为3（客户模式）和4（服务器模式）的NTP报文，以获得客户端与服务器间的网络延迟。
之后，客户端就进入广播客户端模式，继续侦听广播报文的到来，根据到来的广播报文对系统时钟进行同步。

4. 组播模式

在组播模式中，服务器端周期性地向用户配置的组播地址（若用户没有配置组播地址，则使用默认的NTP组播地址224.0.1.1）发送时钟同步报文，
报文中的Mode字段设置为5（组播模式）。客户端侦听来自服务器的组播报文。
当客户端接收到第一个组播报文后，客户端与服务器交互Mode字段为3（客户模式）和4（服务器模式）的NTP报文，
以获得客户端与服务器间的网络延迟。之后，客户端就进入组播客户模式，继续侦听组播报文的到来，根据到来的组播报文对系统时钟进行同步。

