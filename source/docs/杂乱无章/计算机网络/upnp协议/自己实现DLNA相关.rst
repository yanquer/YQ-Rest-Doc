=============================
自己实现DLNA相关
=============================


.. post:: 2024-03-09 18:21:01
  :tags: upnp协议
  :category: 计算机网络
  :author: YanQue
  :location: CD
  :language: zh-cn


前景
=============================

去年买了个投影仪, 奈何想看高分辨率视频还得另外开会员, 最初是网上资源下载到硬盘,
然后用来两种方式:

- 在电脑开启samba协议, 投影仪访问samba共享库
- 把硬盘插投影仪播放

前者对于很大的视频而言, 卡;
后者插个小尾巴, 影响观感, 且不方便.
于是, 多方查询后选择了使用 DLNA 协议来解决(投影仪本身也支持),
又因为Windows自带的很垃圾, 时能用, 时不能用, 重装系统后干脆完全不能用了.

先提前解释一些概念
=============================

多播地址
-----------------------------

多播地址允许在 UDP 层一次性将数据包发送给多台主机,任意主机都可以自动加入和离开多播组,这使其非常适合用于点对多点的应用,
如视频会议、游戏等。

UPnP_ 就采用标准的多播地址 239.255.255.250,实现在局域网中设备服务的自动发现,这也是 UPnP 协议的一大优点。

UPnP
-----------------------------

UPnP 采用标准的 多播地址_  239.255.255.250,
实现在局域网中设备服务的自动发现

大致流程如下:

- 路由器/当前网络/当前设备支持 UPnP
- 当有新的 UPnP 设备加入网络或者发送搜索请求,该设备会向 239.255.255.250:1900 发送生存通告或搜索响应
  (来表示自己是一个 UPnP 设备)
- 同时, UPnP 控制点设备也会使用 UDP 发送搜索请求到 239.255.255.250:1900,发现网络中的 UPnP 设备。

简单来说:

- UPnP 设备使用 239.255.255.250:1900 主动发送生存通告,以发布自己。
- UPnP 控制点使用 239.255.255.250:1900 发送搜索请求,以发现 UPnP 设备。
- UPnP 设备收到搜索请求后,会响应到请求来源(控制点),向其发送设备描述等信息。
- 然后控制点和设备之间可以建立直接的 TCP 连接,用于设备控制、事件通知等。

.. note::

  - UPnP 设备: 每个 UPnP 设备 都可视作一个单独的服务端, 提供服务;
    需要遵循 UPnP 设备架构,提供设备描述、服务描述等, 如媒体服务器、路由器等。
  - UPnP 控制点: 可视作 UPnP 客户端, 访问和控制服务;
    需要遵循 UPnP 控制点架构,知道如何发现设备、查询服务并控制, 如 Windows Media Player。

这就是 UPnP 中使用 UDP 多播在局域网中实现设备发现的基本过程。
每个 UPnP 设备和控制点都需要支持这个标准的多播地址和端口(都需要绑定到标准的多播地址 239.255.255.250 和端口 1900 上,),
才能实现互相发现和交互。
通过这种基于 UDP 多播的方式,UPnP 设备和控制点不需要事先知道彼此的 IP 地址,就可以实现自动发现与使用,这也是 UPnP 协议的一大优点。

UPnP 的主要功能包括:

1. 设备发现:UPnP 设备可以动态加入和离开网络,并通过 UPnP 发现协议被自动检测。
2. 设备控制:UPnP 设备可以通过控制协议远程控制和查询。
3. 事件通知:UPnP 设备可以异步通知控制点有关设备状态的改变。
4. 服务描述:UPnP 设备包含 XML 设备和服务描述,用于将设备功能及接口公开给控制点。
5. 基本架构:UPnP 协议基于开放互联网基础设施工作组(Open InterConnect Consortium)制定的架构。

UPnP 主要由以下几个协议组成:

1. 发现协议(SSDP):处理新设备的加入和离开。
2. 设备和服务描述协议(XML):描述设备和服务的功能及接口。
3. 控制协议(SOAP):提供设备远程控制和查询的机制。
4. 事件通知协议(GENA):提供设备主动通知控制点状态变化的机制。

UPnP 已广泛应用于家庭自动化、互联网接入服务等领域。主流的 UPnP 设备和控制点有 Windows 系列操作系统、各种路由器、媒体中心等。

详细点的工作机制说明: UPnP 的工作机制主要包括:地址分配、发现、描述、控制和事件通知五部分。

1. 地址分配:UPnP 设备加入网络后,通过自动配置或动态主机配置协议(DHCP)获得一个 IP 地址。
2. 发现:UPnP 设备通过简单服务发现协议(SSDP)广播自己的存在,并侦听其他设备的广播。发现过程中交换设备的唯一标识符、URL 等信息。
3. 描述:每个 UPnP 设备都有一个 XML 设备描述文件和一个或多个服务描述文件,描述设备和服务的详细信息。这些描述文件根据 UPnP 设备架构制定。
4. 控制:UPnP 使用简单对象访问协议(SOAP)实现设备的远程控制和查询。
5. 事件通知:UPnP 使用通用事件通知架构(GENA)使设备能主动通知控制点其内部状态的变化。

UPnP 已广泛应用于各种智能家居和互联网接入设备。
在 Windows 系统、各种路由器、NAS 存储设备中都采用了 UPnP 技术。
UPnP 简单易用,跨平台和互operability,已成为智能家庭网络联接的重要基石。

Windows开关流媒体支持
=============================

暂时只介绍最简单的

打开: 打开Windows Media Player, 点击流媒体, 根据提示打开
关闭: 去网络共享中心重制当前网络设置(没有直接关闭窗口)

参考
=============================

- `源代码分析及 DLNA 和 UPnP 协议理解 <https://breezetemple.github.io/2019/03/01/dlna-and-upnp-protocol/>`_
- `UPnP基本原理以及在NAT中的应用 <https://www.h3c.com/cn/d_201206/922127_30005_0.htm>`_
- `alljoyn物联网 <https://www.cnblogs.com/alljoyn/p/3562064.html>`_  (这个没啥看的)
- `UPnP协议编程实践 <https://www.cnblogs.com/hnrainll/archive/2012/07/24/2606641.html>`_  (这个缺少图片)

更新一下

上面的文档忘了是啥了, 重搜了一下

- https://www.cnblogs.com/lcw/p/3416730.html
- https://blog.csdn.net/maimang1001/article/details/122970389   这个有图片展示
- https://blog.csdn.net/weixin_41010318/article/details/78836718
